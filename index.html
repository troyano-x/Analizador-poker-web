<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Poker Juanito – Analizador</title>

  <!-- Pre-carga del fondo -->
  <link rel="preload" as="image" href="assets/fondo-dealer-mobile.png">

  <style>
    :root{
      --table-img: url("assets/fondo-dealer-mobile.png");

      /* Tamaños base */
      --cardW: clamp(56px, 8.8vw, 100px);   /* cartas en mesa */
      --cardWPre: clamp(40px, 6.6vw, 76px); /* slots preboard */
      --pickW: clamp(38px, 10.7vw, 70px);   /* cartas en selector */
      --pad: clamp(12px, 3.2vw, 26px);

      /* Colores */
      --ink:#ffffff; --ink-dim:#e8f3ed; --gold:#eacb7b;
      --j1:#34d399; --j2:#f87171; --emp:#cbd5e1;
      --glass: rgba(16,24,16,.24);
      --stroke: rgba(255,255,255,.22);
      --disabled: rgba(255,255,255,.45);
    }

    body{
      margin:0; font-family: system-ui, Arial, sans-serif; color:var(--ink);
      background:
        var(--table-img) center/cover no-repeat fixed,
        repeating-linear-gradient(90deg,#784d2c 0px,#7f5230 60px,#774a28 60px,#6d4324 120px);
    }
    @media (max-width: 768px){ body{ background-attachment: scroll; } }

    .page{ padding: clamp(8px,2.4vw,18px); }

    /* ===== MESA (escena) ===== */
    .table{
      position: relative;
      margin: 0 auto;
      height: min(100vh, 880px);
      aspect-ratio: 9/16;
      border-radius: 28px;
      overflow: hidden;
      background:
        radial-gradient(60% 70% at 50% 62%, rgba(0,0,0,.30), rgba(0,0,0,.62) 70%),
        var(--table-img) center/cover no-repeat;
      box-shadow: 0 24px 60px rgba(0,0,0,.55), inset 0 2px 0 rgba(255,255,255,.08);
    }
    @media (min-aspect-ratio: 4/3){
      .table{ aspect-ratio: 16/9; height: auto; max-width: 1100px; }
    }

    /* Logo */
    .logo{
      position:absolute; left: clamp(12px,2vw,22px); top: clamp(10px,1.8vw,18px);
      display:flex; align-items:center; gap:8px; padding: 6px 12px; border-radius:999px;
      background: radial-gradient(circle at 30% 20%, #ef4444 0%, #9a1b1b 70%);
      color:#fff; font-weight:800; letter-spacing:.4px; text-transform:uppercase;
      box-shadow: 0 6px 14px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.25);
      z-index: 3;
    }
    .logo .chip{
      width: clamp(16px,2.6vw,22px); height: clamp(16px,2.6vw,22px); border-radius:50%;
      background: radial-gradient(circle at 35% 35%, #fff 0%, #ffd86a 30%, #a6761a 70%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6), inset 0 -2px 4px rgba(0,0,0,.35);
    }

    /* Selector de modo */
    .mode{
      position:absolute; right: clamp(10px,2vw,18px); top: clamp(10px,1.8vw,18px);
      display:flex; gap:6px; padding:6px; border-radius:999px;
      background: var(--glass); border:1px solid var(--stroke);
      backdrop-filter: blur(6px); z-index: 3;
    }
    .mode button{
      border:1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.08);
      color:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:700;
    }
    .mode button.active{ border-color: var(--gold); background: rgba(234,203,123,.18); }

    /* Slots (manos y preboard) */
    .slot{
      width: var(--cardW);
      height: calc(var(--cardW) * 1.5);
      border-radius: 12px;
      border:1px dashed rgba(255,255,255,.46);
      background: linear-gradient(180deg, #297e50, #1b6a43);
      color:#eaf3ed;
      display:grid; place-items:center; font-weight:800; cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 6px 12px rgba(0,0,0,.25);
      position:relative; overflow:hidden; text-shadow:0 1px 0 rgba(0,0,0,.35);
    }
    .slot.small{ width: var(--cardWPre); height: calc(var(--cardWPre) * 1.5); }
    .slot:hover{ filter: brightness(1.03); }
    .slot img{ display:none; width:100%; height:100%; object-fit:contain; position:absolute; inset:0;
               filter: drop-shadow(0 6px 12px rgba(0,0,0,.35)); }
    .slot.filled{ border-style: solid; border-color: rgba(255,255,255,.46); }
    .slot.filled span{ visibility:hidden; }
    .slot.filled img{ display:block; }
    .slot.disabled{
      opacity:.45; filter: grayscale(.7);
      cursor:not-allowed; pointer-events: none;
      border-color: var(--disabled);
    }

    /* Manos */
    .player-side{
      position:absolute; top: 71%; transform: translateY(-50%);
      display:flex; gap: 10px; align-items:center; z-index: 1;
    }
    .player-side.left  { left: 5%;  flex-direction: row; }
    .player-side.right { right: 5%; flex-direction: row-reverse; }
    @media (min-aspect-ratio: 4/3){
      .player-side.left  { left: 7%; top: 70%; }
      .player-side.right { right: 7%; top: 70%; }
    }

    /* Preboard (visible en Turn/River) */
    .preboard{
      position:absolute; left:50%; top: 44%;
      transform: translate(-50%, -50%);
      display:flex; gap: 8px; align-items:center; z-index:1; display:none;
      padding:6px 10px; border-radius:12px;
      background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(4px);
    }
    .preboard.show{ display:flex; }
    .pre-hint{ font-size:.85rem; opacity:.95; margin-right:6px; white-space:nowrap; }

    /* Board centrado con animación */
    .board-center{
      position:absolute; left:50%; top:56%;
      transform: translate(-50%, -50%);
      display:flex; gap: 10px; align-items:center; z-index: 1;
    }
    .card{ width:var(--cardW); height:calc(var(--cardW)*1.5); object-fit:contain;
           border-radius:10px; border:1px solid rgba(255,255,255,.35);
           box-shadow: 0 6px 12px rgba(0,0,0,.35); background:rgba(255,255,255,.08); }
    .board-card{ opacity:0; transform: translateY(-16px) rotateX(70deg); transform-origin: bottom center; }
    .board-card.deal{ animation: deal .55s ease forwards; }
    @keyframes deal{ to{ opacity:1; transform: translateY(0) rotateX(0); } }

    /* Resultado */
    .result-banner{
      position:absolute; left:50%; top: 70%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
      padding: 6px 10px; border-radius: 999px;
      font-weight: 800; letter-spacing:.2px; z-index: 1;
    }

    /* ===== DOCK inferior ===== */
    .dock{
      position: sticky; bottom: 0; z-index: 5;
      max-width: min(1100px, 96vw);
      margin: 10px auto 0;
      display: grid; gap: 10px;
      background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
      padding-top: 8px;
    }

    /* Tarjeta resultados */
    .stats{
      padding: 12px; border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 10px 24px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.12);
      color:#fff; backdrop-filter: blur(6px);
    }
    .stats-title{ font-weight:800; letter-spacing:.3px; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
    .stat-row{ display:flex; align-items:center; gap:8px; margin:8px 0; }
    .badge{ min-width:86px; padding:6px 10px; border-radius:10px; font-weight:800; text-align:center; }
    .badge.j1{ background: rgba(52,211,153,.22); border:1px solid var(--j1); }
    .badge.j2{ background: rgba(248,113,113,.22); border:1px solid var(--j2); }
    .badge.emp{ background: rgba(203,213,225,.24); border:1px solid var(--emp); color:#0f172a; }
    .bar{ flex:1; height:12px; background: rgba(255,255,255,.12); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.18); }
    .fill{ height:100%; width:0; border-radius:999px; transition: width .7s ease; }
    .fill.j1{ background: var(--j1); } .fill.j2{ background: var(--j2); } .fill.emp{ background: var(--emp); }
    .pct{ width:64px; text-align:right; font-weight:700; }

    /* HUD (botones + selector simulaciones) */
    .hud{
      display:flex; gap:10px; flex-wrap: wrap;
      justify-content: space-between; align-items:center;
      background: var(--glass); border:1px solid var(--stroke);
      backdrop-filter: blur(6px);
      padding: 10px; border-radius: 16px;
    }
    .hud-left, .hud-right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hud .btn{
      padding: 10px 14px; font-size:.95rem; border-radius:999px;
      background: transparent; color:#fff;
      border:1px solid rgba(255,255,255,.28); cursor:pointer;
      min-width: 140px;
    }
    .hud .btn:hover{ filter:brightness(1.06); }
    .hud .btn.primary{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.55); }

    .sim-ctrl{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .sim-ctrl .label{ opacity:.9; font-weight:700; }
    .seg{ display:flex; gap:6px; }
    .pill{
      border:1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.08);
      color:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:700;
    }
    .pill.active{ border-color: var(--gold); background: rgba(234,203,123,.18); }
    .sim-input{
      width: 92px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.08); color:#fff; outline:none;
    }

    /* ====== Móvil ====== */
    @media (max-width: 480px) {
      :root{ --cardW: 56px; --cardWPre: 48px; --pad: 10px; }
      .table{ height: min(92vh, 760px); }
      .logo{ transform: scale(.90); transform-origin: left top; }
      .player-side{ gap: 8px; top: 40%; }
      .player-side.left{ left: 4%; } .player-side.right{ right: 4%; }
      .preboard{ top: 46%; gap: 6px; }
      .board-center{ top: 60%; gap: 6px; }
      .result-banner{ top: 40%; font-size: .95rem; padding: 4px 8px; }
      .hud-left{ flex:1 1 100%; justify-content:space-between; }
      .hud-right{ flex:1 1 100%; justify-content:space-between; }
      .hud .btn{ flex: 1 1 calc(50% - 10px); min-width: 46%; }
    }

    @media (min-width: 481px) and (max-width: 1024px){
      :root{ --cardW: clamp(60px, 6.5vw, 88px); --cardWPre: clamp(48px, 5.2vw, 72px); }
      .board-center{ gap: 8px; top: 54%; }
      .player-side{ top: 65%; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ===== MESA ===== -->
    <div class="table">
      <div class="logo"><span class="chip"></span> Poker Juanito</div>

      <!-- Selector de modo -->
      <div class="mode" id="modeBar">
        <button data-mode="full" class="active" type="button">Board completo</button>
        <button data-mode="turn" type="button">Desde Turn</button>
        <button data-mode="river" type="button">Desde River</button>
      </div>

      <!-- Manos -->
      <div class="player-side left">
        <button class="slot" data-slot="j1c1" title="J1"><span>Elegir</span><img alt=""></button>
        <button class="slot" data-slot="j1c2" title="J1"><span>Elegir</span><img alt=""></button>
      </div>
      <div class="player-side right">
        <button class="slot" data-slot="j2c1" title="J2"><span>Elegir</span><img alt=""></button>
        <button class="slot" data-slot="j2c2" title="J2"><span>Elegir</span><img alt=""></button>
      </div>

      <!-- Preboard (solo Turn / River) -->
      <div class="preboard" id="preboard">
        <div class="pre-hint" id="preHint">Fija el flop (3):</div>
        <button class="slot small" data-slot="b0"><span>Flop 1</span><img alt=""></button>
        <button class="slot small" data-slot="b1"><span>Flop 2</span><img alt=""></button>
        <button class="slot small" data-slot="b2"><span>Flop 3</span><img alt=""></button>
        <button class="slot small" data-slot="b3"><span>Turn</span><img alt=""></button>
        <button class="slot small" data-slot="b4"><span>River</span><img alt=""></button>
      </div>

      <!-- Board -->
      <div class="board-center">
        <img id="board0" class="card board-card" alt="">
        <img id="board1" class="card board-card" alt="">
        <img id="board2" class="card board-card" alt="">
        <img id="board3" class="card board-card" alt="">
        <img id="board4" class="card board-card" alt="">
      </div>

      <!-- Resultado -->
      <div id="resultado" class="result-banner"></div>

      <!-- Inputs ocultos -->
      <input id="j1c1" type="hidden"><input id="j1c2" type="hidden">
      <input id="j2c1" type="hidden"><input id="j2c2" type="hidden">
      <input id="b0" type="hidden"><input id="b1" type="hidden"><input id="b2" type="hidden">
      <input id="b3" type="hidden"><input id="b4" type="hidden">
      <input id="sims" type="hidden" value="1000">
    </div>

    <!-- ===== DOCK inferior ===== -->
    <div class="dock">
      <!-- Tarjeta de resultados -->
      <div id="simu"></div>

      <!-- HUD: botones + selector simulaciones -->
      <div class="hud">
        <div class="hud-left">
          <button class="btn primary" id="btnBoardEval">Repartir / Completar</button>
          <button class="btn" id="btnSimular">Simular</button>
          <button class="btn" id="btnSwap">Intercambiar</button>
          <button class="btn" id="btnLimpiar">Limpiar</button>
        </div>

        <div class="hud-right">
          <div class="sim-ctrl">
            <span class="label">Simulaciones:</span>
            <div class="seg" id="simPills">
              <button class="pill" data-sims="100">100</button>
              <button class="pill active" data-sims="1000">1k</button>
              <button class="pill" data-sims="10000">10k</button>
            </div>
            <input class="sim-input" type="number" id="simsInput" min="10" max="200000" step="10" value="1000" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODAL SELECTOR ===== -->
  <div class="picker-backdrop" id="pickerBackdrop" aria-hidden="true">
    <div class="picker" role="dialog" aria-modal="true">
      <div class="picker-header" style="gap:12px;">
        <div style="min-width:220px">
          <div class="picker-title" id="pickerTitle">Elige una carta</div>
          <div class="picker-hint">Busca por código (ej. <b>10D</b>, <b>AC</b>, <b>7P</b>). Palos: ♥=C, ♦=D, ♠=P, ♣=T.</div>
        </div>
        <div class="suits" id="suits">
          <button class="suit-btn active" data-suit="">Todas</button>
          <button class="suit-btn" data-suit="C">♥</button>
          <button class="suit-btn" data-suit="D">♦</button>
          <button class="suit-btn" data-suit="P">♠</button>
          <button class="suit-btn" data-suit="T">♣</button>
        </div>
        <div class="search">
          🔎 <input id="pickerSearch" type="text" placeholder="Buscar carta..." />
          <button class="btn" id="btnClearSearch" type="button">Limpiar</button>
          <button class="btn" id="btnClosePicker" type="button">Cerrar</button>
        </div>
      </div>
      <div class="picker-grid" id="pickerGrid"></div>
      <div class="picker-actions">
        <button class="btn" id="btnClearSlot" type="button">Quitar carta</button>
        <button class="btn primary" id="btnAcceptPicker" type="button">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== LÓGICA ====== */
    const valores = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const palos = ['C','D','P','T']; // C=♥, D=♦, P=♠, T=♣
    const cartas = []; for (const v of valores) for (const p of palos) cartas.push(v+p);
    const png = (code) => `Cartas/${code}.png`;

    /* ---- util DOM ---- */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // Guardar texto por defecto de cada slot (para restaurar en limpiar)
    $$('.slot').forEach(btn=>{
      const span=btn.querySelector('span'); if(span) btn.dataset.default=span.textContent;
      btn.addEventListener('click', ()=>{
        if (btn.classList.contains('disabled')) return; // no abrir si deshabilitado
        openPicker(btn.dataset.slot);
      });
      const img = btn.querySelector('img');
      if (img) img.addEventListener('click', (e)=>{
        e.stopPropagation();
        if (btn.classList.contains('disabled')) return;
        openPicker(btn.dataset.slot);
      });
    });

    function setSlotValue(slot, code){
      document.getElementById(slot).value = code || '';
      const btn = document.querySelector(`.slot[data-slot="${slot}"]`);
      if (!btn) return;
      const img = btn.querySelector('img');
      const label = btn.querySelector('span');
      if (code){
        if (img) img.src = png(code);
        btn.classList.add('filled');
        if (label) label.textContent = code;
      }else{
        if (img) img.src = '';
        btn.classList.remove('filled');
        if (label){
          if (slot.startsWith('b')) label.textContent = btn.dataset.default || label.textContent;
          else label.textContent = 'Elegir';
        }
      }
    }

    function validarManos(){
      const h = ['j1c1','j1c2','j2c1','j2c2'].map(id=>document.getElementById(id).value);
      if (h.some(c => !c)) { alert('❌ Debes seleccionar las 4 cartas (2 por jugador).'); return null; }
      if (new Set(h).size !== h.length) { alert('❌ No se pueden repetir cartas entre jugadores.'); return null; }
      return h;
    }

    function usadasSet(extraIds=[]){
      const ids=['j1c1','j1c2','j2c1','j2c2', ...extraIds];
      const s=new Set();
      ids.forEach(id=>{ const v=document.getElementById(id)?.value; if (v) s.add(v); });
      return s;
    }

    // Preboard helpers
    function applicablePreboardIds(mode){
      if (mode==='turn')  return ['b0','b1','b2'];         // flop fijo
      if (mode==='river') return ['b0','b1','b2','b3'];    // flop+turn fijos
      return []; // full
    }

    function getFixedBoardByMode(mode){
      const b0 = document.getElementById('b0').value;
      const b1 = document.getElementById('b1').value;
      const b2 = document.getElementById('b2').value;
      const b3 = document.getElementById('b3').value;
      const b4 = document.getElementById('b4').value;
      if (mode==='turn'){
        if (!b0 || !b1 || !b2){ alert('⚠️ En modo "Desde Turn" debes fijar las 3 cartas del Flop.'); return null; }
        return [b0,b1,b2,null,null];
      }
      if (mode==='river'){
        if (!b0 || !b1 || !b2 || !b3){ alert('⚠️ En modo "Desde River" debes fijar Flop (3) y Turn (1).'); return null; }
        return [b0,b1,b2,b3,null];
      }
      return [null,null,null,null,null];
    }

    function completarBoard(mode, usadas){
      const fixed = getFixedBoardByMode(mode); if (!fixed) return null;
      const disp = cartas.filter(c => !usadas.has(c));
      const pickOne = () => { const k=Math.floor(Math.random()*disp.length); const v=disp[k]; disp.splice(k,1); return v; };
      const board = [...fixed];
      for (let i=0;i<5;i++){ if (!board[i]) board[i]=pickOne(); }
      return board;
    }

    /* ===== Evaluador Hold'em ===== */
    const vA = (v) => v==='A'?14 : v==='K'?13 : v==='Q'?12 : v==='J'?11 : parseInt(v,10);
    const parse = (c)=>({r:vA(c.slice(0,-1)), s:c.slice(-1)});
    const uniqDesc = a => [...new Set(a)].sort((x,y)=>y-x);
    const uniqAsc  = a => [...new Set(a)].sort((x,y)=>x-y);
    function straightHigh(ranks){
      let u = uniqAsc(ranks); if (u.includes(14)) u = [1, ...u];
      let best=0, run=1;
      for (let i=1;i<u.length;i++){
        if (u[i]===u[i-1]+1){ run++; if (run>=5) best = Math.max(best, u[i]===1?5:u[i]); }
        else run=1;
      }
      return best;
    }
    function best5of7(codes){
      const cs = codes.map(parse), ranks = cs.map(c=>c.r).sort((a,b)=>b-a);
      const cnt = new Map(), suit = new Map();
      for (const c of cs){ cnt.set(c.r,(cnt.get(c.r)||0)+1); (suit.get(c.s)||suit.set(c.s,[]),suit.get(c.s)).push(c.r); }
      let flushS=null, flushR=[];
      for (const [s,arr] of suit){ if (arr.length>=5){ flushS=s; flushR=arr.sort((a,b)=>b-a); break; } }
      if (flushS){ const sf=straightHigh(flushR); if (sf) return {cat:8,t:[sf],d:'Escalera color'}; }
      const groups={4:[],3:[],2:[],1:[]}; for (const [r,c] of cnt) groups[c].push(r);
      for (const k of [4,3,2,1]) groups[k].sort((a,b)=>b-a);
      if (groups[4].length){ const q=groups[4][0], k=uniqDesc(ranks.filter(r=>r!==q))[0]; return {cat:7,t:[q,k],d:'Póker'}; }
      if (groups[3].length && (groups[2].length || groups[3].length>=2)){ const t=groups[3][0], p=groups[3].length>=2?groups[3][1]:groups[2][0]; return {cat:6,t:[t,p],d:'Full'}; }
      if (flushS){ const top=uniqDesc(flushR).slice(0,5); return {cat:5,t:top,d:'Color'}; }
      const st=straightHigh(ranks); if (st) return {cat:4,t:[st],d:'Escalera'};
      if (groups[3].length){ const t=groups[3][0], ks=uniqDesc(ranks.filter(r=>r!==t)).slice(0,2); return {cat:3,t:[t,...ks],d:'Trío'}; }
      if (groups[2].length>=2){ const [p1,p2]=groups[2].slice(0,2), k=uniqDesc(ranks.filter(r=>r!==p1&&r!==p2))[0]; return {cat:2,t:[p1,p2,k],d:'Doble par'}; }
      if (groups[2].length){ const p=groups[2][0], ks=uniqDesc(ranks.filter(r=>r!==p)).slice(0,3); return {cat:1,t:[p,...ks],d:'Par'}; }
      return {cat:0,t:uniqDesc(ranks).slice(0,5),d:'Carta alta'};
    }
    function cmp(a,b){ if (a.cat!==b.cat) return a.cat-b.cat;
      for (let i=0;i<Math.max(a.t.length,b.t.length);i++){ const va=a.t[i]||0,vb=b.t[i]||0; if (va!==vb) return va-vb; } return 0; }
    function evaluar(manos,board){
      const h1=best5of7([...manos[0],...board]), h2=best5of7([...manos[1],...board]);
      const c=cmp(h1,h2);
      if (c>0) return {g:1,j1:h1.d,j2:h2.d};
      if (c<0) return {g:2,j1:h2.d,j2:h1.d};
      return {g:0,j1:h1.d,j2:h2.d};
    }

    // Intercambiar manos
    $('#btnSwap').onclick = ()=>{
      const a1=$('#j1c1').value, a2=$('#j1c2').value, b1=$('#j2c1').value, b2=$('#j2c2').value;
      setSlotValue('j1c1', b1); setSlotValue('j1c2', b2);
      setSlotValue('j2c1', a1); setSlotValue('j2c2', a2);
    };

    // Animar board
    function pintarBoard(board){
      [0,1,2,3,4].forEach(i=>{
        const img=$('#board'+i);
        img.classList.remove('deal'); void img.offsetWidth;
        img.src = png(board[i]); img.style.animationDelay = (i*0.12)+'s'; img.classList.add('deal');
      });
    }

    // ====== MODO ======
    let MODE = 'full'; // 'full' | 'turn' | 'river'
    const preboard = $('#preboard'); const preHint  = $('#preHint');

    function setSlotDisabled(slotId, disabled){
      const btn = document.querySelector(`.slot[data-slot="${slotId}"]`);
      if (!btn) return;
      btn.classList.toggle('disabled', !!disabled);
      btn.setAttribute('aria-disabled', disabled ? 'true':'false');
    }

    function updatePreboardUIByMode(){
      const ids = ['b0','b1','b2','b3','b4'];
      // reset all to enabled
      ids.forEach(id=>setSlotDisabled(id, false));

      if (MODE==='full'){
        preboard.classList.remove('show');
        return;
      }
      preboard.classList.add('show');

      if (MODE==='turn'){
        preHint.textContent = 'Fija el Flop (3):';
        setSlotDisabled('b3', true); // turn no aplica
        setSlotDisabled('b4', true); // river no aplica
      } else if (MODE==='river'){
        preHint.textContent = 'Fija Flop (3) + Turn (1):';
        setSlotDisabled('b4', true); // river se completa
      }
    }
    updatePreboardUIByMode();

    $('#modeBar').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-mode]'); if (!btn) return;
      $$('#modeBar button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      MODE = btn.dataset.mode;
      updatePreboardUIByMode();
    });

    // Generar según modo + evaluar
    $('#btnBoardEval').onclick = ()=>{
      const manos = validarManos(); if (!manos) return;

      // validar fijos requeridos
      const fixed = getFixedBoardByMode(MODE); if (fixed===null) return;

      // evitar duplicados dentro del preboard aplicable
      const appIds = applicablePreboardIds(MODE);
      const pb = appIds.map(id=>document.getElementById(id).value).filter(Boolean);
      if (new Set(pb).size !== pb.length){ alert('⚠️ Las cartas fijas del board no deben repetirse.'); return; }

      // barajar respetando cartas usadas (solo slots aplicables)
      const usadas = usadasSet(appIds);
      const board = (MODE==='full')
        ? (function(){
            const disp = cartas.filter(c => !usadas.has(c));
            const out=[]; for (let i=0;i<5;i++){ const k=Math.floor(Math.random()*disp.length); out.push(disp[k]); disp.splice(k,1); }
            return out;
          })()
        : completarBoard(MODE, usadas);
      if (!board) return;

      pintarBoard(board);
      const r=evaluar([[manos[0],manos[1]],[manos[2],manos[3]]], board);
      $('#resultado').textContent =
        r.g===1?`🏆 Gana Jugador 1 (${r.j1})`: r.g===2?`🏆 Gana Jugador 2 (${r.j1})`:`🤝 Empate (${r.j1})`;
    };

    // ===== Selector de simulaciones =====
    const simsHidden = $('#sims');
    const simsInput  = $('#simsInput');
    const simPills   = $('#simPills');

    function setSims(val){
      const n = Math.max(10, Math.min(200000, parseInt(val||'1000',10) || 1000));
      simsHidden.value = n;
      simsInput.value = n;
      $$('.pill', simPills).forEach(p=>p.classList.toggle('active', parseInt(p.dataset.sims,10)===n));
    }

    simPills.addEventListener('click', (e)=>{
      const b = e.target.closest('.pill'); if (!b) return;
      setSims(b.dataset.sims);
    });
    simsInput.addEventListener('change', ()=> setSims(simsInput.value));
    setSims(1000); // default

    // Simulación respeta el modo
    $('#btnSimular').onclick = ()=>{
      const manos = validarManos(); if (!manos) return;
      const fb = getFixedBoardByMode(MODE); if (fb===null) return;

      let n=parseInt(simsHidden.value,10); if (!Number.isFinite(n)||n<1) n=1000; n=Math.min(n,200000);

      let w1=0,w2=0,e=0;
      for (let k=0;k<n;k++){
        const appIds = applicablePreboardIds(MODE);
        const usadas = usadasSet(appIds);
        const board = (MODE==='full')
          ? (function(){
              const disp = cartas.filter(c => !usadas.has(c));
              const out=[]; for (let i=0;i<5;i++){ const idx=Math.floor(Math.random()*disp.length); out.push(disp[idx]); disp.splice(idx,1); }
              return out;
            })()
          : completarBoard(MODE, usadas);
        if (!board) return;
        const r=evaluar([[manos[0],manos[1]],[manos[2],manos[3]]], board);
        if (r.g===1) w1++; else if (r.g===2) w2++; else e++;
      }

      const p1=(w1/n*100), p2=(w2/n*100), pe=(e/n*100);
      const html = `
        <div class="stats">
          <div class="stats-title">🧠 Resultado de ${n.toLocaleString()} simulaciones ${
            MODE==='full'?'(board completo)': MODE==='turn'?'(desde Turn; Flop fijo)':'(desde River; Flop+Turn fijos)'}
          </div>
          <div class="stat-row">
            <div class="badge j1">Jugador 1</div>
            <div class="bar"><div class="fill j1" style="width:0%"></div></div>
            <div class="pct">${p1.toFixed(2)}%</div>
          </div>
          <div class="stat-row">
            <div class="badge j2">Jugador 2</div>
            <div class="bar"><div class="fill j2" style="width:0%"></div></div>
            <div class="pct">${p2.toFixed(2)}%</div>
          </div>
          <div class="stat-row">
            <div class="badge emp">Empates</div>
            <div class="bar"><div class="fill emp" style="width:0%"></div></div>
            <div class="pct">${pe.toFixed(2)}%</div>
          </div>
        </div>`;
      const cont = document.getElementById('simu');
      cont.innerHTML = html;
      requestAnimationFrame(()=>{
        cont.querySelector('.fill.j1').style.width = p1+'%';
        cont.querySelector('.fill.j2').style.width = p2+'%';
        cont.querySelector('.fill.emp').style.width = pe+'%';
      });
    };

    // Limpiar todo
    $('#btnLimpiar').onclick = ()=>{
      ['j1c1','j1c2','j2c1','j2c2','b0','b1','b2','b3','b4'].forEach(id=>setSlotValue(id,''));
      ['board0','board1','board2','board3','board4'].forEach(id=>document.getElementById(id).src='');
      document.getElementById('resultado').textContent='';
      document.getElementById('simu').innerHTML='';
    };

    /* ---------- Picker ---------- */
    let currentSlot=null, tempChoice=null, suitFilter='';
    const $p = (id)=>document.getElementById(id);
    const normalize = s => (s||'').toUpperCase().replace(/\s+/g,'');

    function usedSetExcept(except){
      const ids=['j1c1','j1c2','j2c1','j2c2','b0','b1','b2','b3','b4'].filter(x=>x!==except);
      const s=new Set(); ids.forEach(id=>{ const v=$p(id).value; if (v) s.add(v); }); return s;
    }

    function renderPicker(){
      const grid=$p('pickerGrid'); grid.innerHTML='';
      const used=usedSetExcept(currentSlot); const q=normalize($p('pickerSearch').value);
      cartas.forEach(code=>{
        if (suitFilter && !code.endsWith(suitFilter)) return;
        if (q && !normalize(code).includes(q)) return;
        const b=document.createElement('button'); b.className='pick-btn'; b.type='button'; b.title=code;
        b.innerHTML=`<img src="${png(code)}" alt="${code}">`;
        if (used.has(code)) b.disabled=true;
        if (tempChoice===code) b.style.outline='3px solid #cfe9df';
        b.addEventListener('click', ()=>{
          tempChoice=code; [...grid.querySelectorAll('.pick-btn')].forEach(x=>x.style.outline='none'); b.style.outline='3px solid #cfe9df';
        });
        grid.appendChild(b);
      });
    }

    function openPicker(slot){
      currentSlot=slot; tempChoice=$p(slot).value||null;
      $p('pickerTitle').textContent=`Elige una carta (${slot.toUpperCase()})`;
      $p('pickerSearch').value=''; suitFilter='';
      document.querySelectorAll('.suit-btn').forEach(b=>b.classList.toggle('active', b.dataset.suit===''));
      renderPicker();
      $p('pickerBackdrop').classList.add('open'); $p('pickerBackdrop').setAttribute('aria-hidden','false');
      setTimeout(()=> $p('pickerSearch').focus(), 40);
    }
    function closePicker(){ $p('pickerBackdrop').classList.remove('open'); $p('pickerBackdrop').setAttribute('aria-hidden','true'); currentSlot=null; tempChoice=null; }
    $p('pickerSearch').addEventListener('input', renderPicker);
    $p('btnClearSearch').onclick = ()=>{ $p('pickerSearch').value=''; renderPicker(); };
    $p('btnClosePicker').onclick  = closePicker;
    $p('btnAcceptPicker').onclick = ()=>{ if (currentSlot && tempChoice) setSlotValue(currentSlot, tempChoice); closePicker(); };
    $p('btnClearSlot').onclick    = ()=>{ if (currentSlot) setSlotValue(currentSlot,''); closePicker(); };
    $p('pickerBackdrop').addEventListener('click', e=>{ if (e.target.id==='pickerBackdrop') closePicker(); });
    document.getElementById('suits').addEventListener('click', (e)=>{
      const btn=e.target.closest('.suit-btn'); if (!btn) return;
      suitFilter = btn.dataset.suit; document.querySelectorAll('.suit-btn').forEach(b=>b.classList.toggle('active', b===btn));
      renderPicker();
    });
  </script>
</body>
</html>
